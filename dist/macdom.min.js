/* Macdom-js Copyright (c) 2016 Vladimír Macháček | For the full copyright and license information, please view the file license.md that was distributed with this source code. */
(function(){"use strict";var f=function(a){return a.replace(/^\s+/,"")};RegExp.quote=function(a){return(a+'').replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")};var g=function(a,b,c){var d=b.indexOf(a);if(c)return d>=0?d:0;return d>=0};var h=function(a,b){return b.hasOwnProperty(a)};var j=function(a,b){var c,matches=[];while(c=a.exec(b)){matches.push(c)}matches=matches.length?matches:null;return matches};var k=function(a){return new RegExp(a,'g')};var l={},Elements={},Macros={},Replicator={};Macros.macros={};l.construct=function(s){var a=s.closeSelfClosingTags||false,booleansWithValue=s.booleansWithValue||false,preferXhtml=s.preferXhtml||false;if(preferXhtml)a=booleansWithValue=true;this.AREA_TAG='SKIP';this.finallCodeIndentation=s.finallCodeIndentation||"tabs";this.lvlIndentation="";this.skippedTagLvl=null;this.skippedTags=s.skippedTags||[];this.preferXhtml=preferXhtml;this.closeSelfClosingTags=a;this.booleansWithValue=booleansWithValue;this.closeTags=[];this.codeStorage="";this.inNoCompileArea=false;this.skipRow=false;this.noCompileAreaClosed=null;this.lnBreak=s.compressCode?'':"\n";this.spacesPerIndent=s.spacesPerIndent||4;this.structureHtmlSkeleton=s.structureHtmlSkeleton||true;this.indentMethod=s.indentMethod||3;this.ncaCloseTags=s.ncaCloseTags||[];this.ncaOpenTags=s.ncaOpenTags||[];this.ncaRegExpInlineTags=s.ncaRegExpInlineTags||[];this.ncaRegExpOpenTags=s.ncaRegExpOpenTags||[];this.ncaRegExpCloseTags=s.ncaRegExpCloseTags||[]};Elements.construct=function(s){var a,that=Elements;if(s.addBooleanAttributes){a=s.addBooleanAttributes.split(" ");this.booleanAttributes=this.booleanAttributes.concat(a)}if(s.changeQkAttributes){Elements.changeQkAttributes(s.changeQkAttributes)}if(s.removeBooleanAttributes){Elements.removeBooleanAttributes(s.removeBooleanAttributes)}if(s.addElements){Elements.addElements(s.addElements)}if(s.removeElements){Elements.removeElements(s.removeElements)}};Macros.construct=function(s){var a,macros,that=Macros;if(s.addMacros){macros=s.addMacros;for(a in macros){that.addMacro(a,macros[a])}}if(s.removeMacros){that.removeMacros(s.removeMacros)}};Replicator.construct=function(s){this.REG_EXP_A=/\[(.*?)\]/g;this.REG_EXP_B=/\[@\]/;this.REG_EXP_B_g=/\[@\]/g;this.REG_EXP_C=/^@([\S]*)/;this.REG_EXP_D=/^\/@([\S]*)/;this.SUFFIX='-x';this.register={}};l.compile=function(a){var b,i,ln,lvl,txt,element,noCompileAreaTag,replicatorResult,clearedText,attributes,macro,macroExists,re,that=l,lns=a.split(/\n/);if(!a)return'';for(ln of lns){lvl=that.getLnLvl(ln);txt=that.getLnTxt(ln);element=that.getElement(ln);noCompileAreaTag=that.detectNoCompileArea(txt,element,lvl);if(this.lnBreak){b="\t";if(that.finallCodeIndentation==="spaces"){b='    '}that.lvlIndentation='';for(i=0;i<lvl;i++){that.lvlIndentation+=b}}if(that.structureHtmlSkeleton&&element==="html"){lvl=0}else if(that.structureHtmlSkeleton&&element!=="html"){lvl=g(element,["html","body"])?1:lvl+1}if(txt&&!noCompileAreaTag&&f(txt).length&&!that.inNoCompileArea&&!that.skipRow&&that.noCompileAreaClosed===null&&!Elements.findElement(element,false)&&!(txt.trim()).match(/^[<*]+/)){replicatorResult=Replicator.detect(lvl,element,txt);if(replicatorResult['replicate']){txt=that.getLnTxt(replicatorResult['line']);element=that.getElement(txt)}if(replicatorResult['clearLine']){txt=null;element=false}}if(Elements.findElement(element,false)&&!that.inNoCompileArea&&!that.skipRow){clearedText=txt.replace(element,'');attributes=that.processLnAttributes(clearedText);that.addOpenTag(element,lvl,attributes)}else if(txt){that.addCloseTags(lvl);if(!that.inNoCompileArea&&!noCompileAreaTag&&!that.skipRow){macro=Macros.replace(element,txt);macroExists=macro['exists'];that.codeStorage+=macroExists?that.lvlIndentation+macro['replacement']+that.lnBreak:that.lvlIndentation+txt+that.lnBreak}else if(that.inNoCompileArea||that.skipRow){that.codeStorage+=!noCompileAreaTag?that.lvlIndentation+txt+that.lnBreak:""}}}that.addCloseTags(0);return that.codeStorage};l.getElement=function(a){var b=(a.trim()).split(" ");return b[0]};l.getLnTxt=function(a){return f(a)};l.getLnLvl=function(a){var b,whites,spaces,tabulators,matches,re;b=this.indentMethod;matches=a.match(/^\s+/)||null;whites=matches?matches[0]:"";re=new RegExp(" {"+this.spacesPerIndent+"}","g");spaces=b===1||b===3?whites.match(re):0;spaces=spaces?spaces.length:0;tabulators=b===2||b===3?whites.match(/\t/g):0;tabulators=tabulators?tabulators.length:0;if(b===3)tabulators*=2;return spaces+tabulators};l.addCloseTags=function(a){var b=this.closeTags.length,length=b,i;if(length>0){for(i=length-1;i>=0;i--){if(a<=this.closeTags[i][0]){this.codeStorage+=this.closeTags[i][1];b=i}else{break}}this.closeTags.splice(b,this.closeTags.length)}};l.addOpenTag=function(a,b,c){var d,paramKey,selfClosing,attribute,key,closeTag,singleLvl,textIndentation,usedKeys=[],withoutKey=0,that=l,indentation=that.lvlIndentation,elementSettings=Elements.findElement(a,true),openTag=indentation+'<'+a;if(elementSettings['qkAttributes']&&c['qkAttributes']){for(attribute in c['qkAttributes']){key=attribute;attribute=c["qkAttributes"][key];d=null;if(attribute['key']){paramKey=attribute['key']-1;if(typeof elementSettings['qkAttributes'][paramKey]!=='undefined'){d=elementSettings['qkAttributes'][paramKey]+'="'+attribute['value']+'"';usedKeys.push(paramKey)}}else if(!g(withoutKey,usedKeys)&&h(withoutKey,elementSettings['qkAttributes'])){d=elementSettings['qkAttributes'][withoutKey]+'="'+attribute['value']+'"';withoutKey++}openTag+=d?' '+d:""}}openTag+=c['htmlAttributes']+c['booleanAttributes'];selfClosing=elementSettings['paired']||!that.closeSelfClosingTags?'':' /';openTag+=selfClosing+'>'+that.lnBreak;that.addCloseTags(b);that.codeStorage+=openTag;if(elementSettings['paired']){singleLvl='';if(that.lnBreak)singleLvl=that.finallCodeIndentation==="spaces"?'    ':"\t";textIndentation=indentation+singleLvl;that.codeStorage+=c['txt']?textIndentation+c['txt']+that.lnBreak:"";closeTag=indentation+'</'+a+'>'+that.lnBreak;that.closeTags.push([b,closeTag])}};l.processLnAttributes=function(a){var b,i,classes,newHref,htmlAttributes,htmlClsSelector,re,reAll,idSelector,attribute,matches,txt2array,match,paramVal,clsSelectors,qkAttributes,booleanAttributes,paramKey,txtFromTag2End;re=/\<.*$/;txtFromTag2End='';if(match=a.match(re)){a=a.replace(re,'');txtFromTag2End+=match[0]}re=/ -([\w-]+)+=/g;matches=j(re,a);if(matches){for(match of matches){re=new RegExp('-'+match[1]+'=');a=a.replace(re,' data-'+match[1]+'=')}}re=/ [\w:-]+="[^"]*"| [\w:-]+='[^']*'| [\w:-]+=\S+/g;matches=j(re,a);htmlAttributes='';if(matches){a=a.replace(re,'');htmlAttributes=matches.join("")}re=/ #(\S+)/;idSelector=a.match(re);if(idSelector&&!htmlAttributes.match(/ id="[^"]+"|  id='[^']+'| id=[\S]+/))htmlAttributes+=' id="'+idSelector[1]+'"';if(idSelector){while(match=re.exec(a)){a=a.replace(re,'')}}re=/ \.(\S+)/g;matches=j(re,a);clsSelectors='';if(matches){a=a.replace(re,'');for(match of matches){clsSelectors+=" "+match[1]}clsSelectors=f(clsSelectors)}re=/ class="([^"]+)+"| class='([^']+)+'| class=([\S]+)+/;htmlClsSelector=htmlAttributes.match(re);if(clsSelectors&&htmlClsSelector){for(i=1;i<htmlClsSelector.length;i++){if(htmlClsSelector[i]){htmlClsSelector=htmlClsSelector[i];break}}htmlAttributes=htmlAttributes.replace(re,' class="'+htmlClsSelector+' '+clsSelectors+'"')}else if(clsSelectors){htmlAttributes+=' class="'+clsSelectors+'"'}re=/ ([\d]+)?\$(?:([^$;"]+);|(\S+)+)/g;qkAttributes=[];matches=j(re,a);if(matches){a=a.replace(re,'');for(i=0;i<matches.length;i++){attribute=matches[i];paramVal=attribute[attribute.length-1]||attribute[attribute.length-2];if(paramVal&&paramVal.toLowerCase()!=='null'){paramKey=!isNaN(parseFloat(attribute[1]))&&isFinite(attribute[1])?attribute[1]:null;qkAttributes.push({key:paramKey,value:paramVal})}}}a=l.getLnTxt(a)+txtFromTag2End;txt2array=a.split(' ');booleanAttributes='';for(attribute of txt2array){if(Elements.isBoolean(attribute)){a=a.replace(attribute,'');booleanAttributes+=' '+attribute;booleanAttributes+=this.booleansWithValue?'="'+attribute+'"':''}else{break}}return{qkAttributes:qkAttributes,htmlAttributes:htmlAttributes,booleanAttributes:booleanAttributes,txt:a}};l.detectNoCompileArea=function(a,b,c){var d,matchedTag,tag,re,tagDetected,that=l,skipTagClose='/'+that.AREA_TAG,skippedTags=["style","script","code"].concat(that.skipTags),openTags=['<style>','<script>','<?php','<?',that.AREA_TAG].concat(that.ncaOpenTags),closeTags=['</style>','</script>','?>',skipTagClose].concat(that.ncaCloseTags),regExpInlineTags=[/^\s*\<(?:\?|php) .*\?\>/,/^\s*\<(?:script|style) *[^>]*\>.*\<\/(?:style|script)\>/].concat(that.ncaRegExpInlineTags),regExpOpenTags=[/^\s*\<(?:script|style) *[^>]*\>/].concat(that.ncaRegExpOpenTags),regExpCloseTags=[/.*\<\/(?:style|script)\>$/,/.*\?\>$/,skipTagClose].concat(that.ncaRegExpCloseTags);a=a.trim();if(that.skipRow)that.skipRow=that.inNoCompileArea=false;d=that.inNoCompileArea?false:null;if(g(b,skippedTags)&&that.skippedTagLvl===null){that.skippedTagLvl=c}else if(that.skippedTagLvl!==null&&c>that.skippedTagLvl){this.skipRow=true}else if(that.skippedTagLvl!==null&&c<=that.skippedTagLvl&&g(b,skippedTags)){that.skippedTagLvl=c}else{that.skippedTagLvl=null}if(!that.skippedTagLvl){if(g(a.trim(),openTags)){that.inNoCompileArea=true}else if(g(a.trim(),closeTags)){that.inNoCompileArea=false}else{matchedTag=false;if(!that.inNoCompileArea){for(tag of regExpInlineTags){if(a.match(tag)){matchedTag=that.skipRow=true;break}}}if(!matchedTag&&!that.inNoCompileArea){for(tag of regExpOpenTags){if(a.match(tag)){matchedTag=that.inNoCompileArea=true;break}}}if(!matchedTag&&that.inNoCompileArea){for(tag of regExpCloseTags){if(a.match(tag)){that.skipRow=true;that.inNoCompileArea=false;break}}}}}tagDetected=a===that.AREA_TAG||a===skipTagClose;that.noCompileAreaClosed=d;return tagDetected};Replicator.detect=function(a,b,c){var d,isRegistered,key,that=Replicator,replicate,clearLine=false,replacement=null,registrationLine=c.match(that.REG_EXP_C);if(registrationLine){clearLine=true;c=c.replace(RegExp.quote(b),'')}d=that.deregisterLvl(a,b);if(!d&&c.length){isRegistered=that.isRegistered(a,b,c,registrationLine);if(isRegistered['registered']&&!registrationLine){replicate=true;key=isRegistered['key'];replacement=key===true?that.replicate(isRegistered['registerId'],c,b,key):that.replicate(isRegistered['registerId'],c,null,false)}}else{clearLine=true}return{replicate:replicate,clearLine:clearLine,line:replacement}};Replicator.replicate=function(a,b,c,d){var e,that=Replicator,contentArrays=j(that.REG_EXP_A,b);if(d)b=b.replace(RegExp.quote(c),'');e=contentArrays?that.synchronizeLines(b,a,contentArrays):that.synchronizeLines(b,a,null);return e};Replicator.synchronizeLines=function(a,b,c){var d,clear,match,re,that=Replicator,reB=that.REG_EXP_B,registeredLine=that.register[b];if(c){for(match of c){d=registeredLine.match(reB);if(d){registeredLine=registeredLine.replace(reB,match[1]);a=f(a.replace(match[0],''))}else{break}}}re=that.REG_EXP_B_g;clear=registeredLine.replace(re,'');return(clear+a).trim()};Replicator.deregisterLvl=function(a,b){var c,that=Replicator,unregistered=false,match=b.match(that.REG_EXP_D);if(match){c=a+that.SUFFIX;if(match[1].length){c=a+'-'+match[1];if(that.register[c]){delete that.register[c];unregistered=true}}else if(that.register[c]){delete that.register[c];unregistered=true}}return unregistered};Replicator.isRegistered=function(a,b,c,d){var e,that=Replicator,registered=false,key=false,registerId=null;if(!d){if(h(a+'-'+b,that.register)){registered=key=true;registerId=a+'-'+b}else if(h(a+that.SUFFIX,that.register)){registered=true;registerId=a+that.SUFFIX}}if(!registered||d){e=that.registerLvl(b,c,a);registered=e['registered'];registerId=e['registerId']}return{registered:registered,key:key,registerId:registerId}};Replicator.registerLvl=function(a,b,c){var d=Replicator,registered=false,registerId=null,matches=a.match(d.REG_EXP_C);if(matches){registerId=c;registerId+=matches[1]?'-'+matches[1]:d.SUFFIX;d.register[registerId]=b;registered=true}return{registered:registered,registerId:registerId}};Macros.replace=function(a,b){var c,re,macroFn,that=Macros,replacement=null,exists=false;if(that.macros[a]){re=new RegExp("^"+RegExp.quote(a));c=f(b.replace(re,''));replacement=that.macros[a](c);exists=true}return{exists:exists,replacement:replacement}};Macros.addMacro=function(a,b){var c=Macros;if(!h(a,c.macros))c.macros[a]=b};Macros.removeMacros=function(a){if(typeof a==="string"){var b;a=a.split(" ");for(b of a){if(h(b,this.macros)){delete this.macros[b]}}}};Elements.isBoolean=function(a){return g(a,Elements.booleanAttributes)};Elements.findElement=function(a,b){var c=false;if(g(a,Elements.elements))c=b?Elements.getElementSettings(a):true;return c};Elements.getElementSettings=function(a){var s,qkAttributes=null,paired=true,settings=Elements.elementsSettings;if(h(a,settings)){s=settings[a];paired=!h("unpaired",s);qkAttributes=h("qkAttributes",s)?s['qkAttributes']:null}return{element:a,paired:paired,qkAttributes:qkAttributes}};Elements.addBooleanAttributes=function(a){if(typeof a==="string"){a=a.splice(" ");Elements.booleanAttributes.concat(a)}};Elements.removeBooleanAttributes=function(a){if(typeof a==="string"){var b,attribute;a=a.split(" ");for(attribute of a){b=g(attribute,this.booleanAttributes,true);if(b>=0){delete this.booleanAttributes[b]}}}};Elements.addElements=function(a){if(typeof a==="object"){var b,elementSettings;for(b in a){elementSettings=a[b];if(elementSettings){this.elementsSettings[b]=elementSettings}this.elements.push(b)}}};Elements.removeElements=function(a){if(typeof a==="string"){var a,elementKey,element;a=a.split(" ");for(element of a){elementKey=g(element,this.elements,true);if(elementKey>=0)delete this.elements[elementKey];delete this.elementsSettings[element]}}};Elements.changeQkAttributes=function(a){if(typeof a==="object"){var b,attribute,newAttribute,attrKey,actAttribute,element,elementKey,removeAttributes=[];if(a&&typeof a==="object"){for(elementKey in a){element=elementKey;b=a[elementKey];for(attribute in b){actAttribute=attribute;newAttribute=b[attribute];if(h(element,this.elementsSettings)&&h("qkAttributes",this.elementsSettings[element])&&g(actAttribute,this.elementsSettings[element]["qkAttributes"])){if(newAttribute){attrKey=g(actAttribute,this.elementsSettings[element]["qkAttributes"],true);this.elementsSettings[element]["qkAttributes"][attrKey]=newAttribute}else{removeAttributes.push(actAttribute)}}}if(removeAttributes){for(attribute of removeAttributes){attrKey=g(attribute,this.elementsSettings[element]["qkAttributes"],true);delete this.elementsSettings[element]["qkAttributes"][attrKey]}}}}}};Elements.elements=['a','abbr','address','area','article','aside','audio','b','base','bdi','bdo','blockquote','body','br','button','canvas','caption','cite','code','col','colgroup','data','datalist','dd','del','dfn','div','dl','dt','element','em','embed','fieldset','figcaption','figure','footer','form','h1','h2','h3','h4','h5','h6','head','header','hr','html','i','iframe','img','input','ins','kbd','label','legend','li','link','main','map','mark','meta','meter','nav','noframes','noscript','object','ol','optgroup','option','output','p','param','pre','progress','q','rp','rt','rtc','ruby','s','samp','script','section','select','shadow','small','source','span','strong','style','sub','sup','table','tbody','td','template','textarea','tfoot','th','thead','time','title','tr','track','u','ul','var','video','wbr','bgsound','details','dialog','hgroup','image','menu','menuitem','multicol','nobr','picture','summary'];Elements.booleanAttributes=['autofocus','autoplay','async','contenteditable','controls','default','defer','disabled','draggable','formnovalidate','hidden','checked','ismap','loop','multiple','muted','open','readonly','required','selected','spellcheck','n:ifcontent'];Elements.elementsSettings={a:{qkAttributes:['href','target','role']},abbr:{qkAttributes:['title']},area:{unpaired:true},audio:{qkAttributes:['src']},base:{unpaired:true},bdo:{qkAttributes:['dir']},br:{unpaired:true},button:{qkAttributes:['type','value']},canvas:{qkAttributes:['width','height']},col:{unpaired:true,qkAttributes:['span']},data:{qkAttributes:['value']},embed:{unpaired:true,qkAttributes:['src','type','width','height']},form:{qkAttributes:['method']},hr:{unpaired:true},html:{qkAttributes:['lang']},iframe:{qkAttributes:['src','frameborder','width','height']},img:{unpaired:true,qkAttributes:['src','alt']},input:{unpaired:true,qkAttributes:['type','value','placeholder']},label:{qkAttributes:['for']},link:{unpaired:true,qkAttributes:['href','rel','title']},meta:{unpaired:true,qkAttributes:['name','content']},object:{qkAttributes:['data','type']},ol:{qkAttributes:['type','start','reversed']},optgroup:{qkAttributes:['label']},option:{qkAttributes:['value']},param:{unpaired:true,qkAttributes:['name','value']},progress:{qkAttributes:['value','max']},q:{qkAttributes:['cite']},script:{qkAttributes:['src','type']},source:{unpaired:true,qkAttributes:['src','type']},style:{qkAttributes:['type']},td:{qkAttributes:['rowspan','colspan']},textarea:{qkAttributes:['placeholder']},track:{unpaired:true,qkAttributes:['src','srclang','kind']},wbr:{unpaired:true},menu:{qkAttributes:['type','label']},menuitem:{qkAttributes:['type']}};Macros.addMacro("!5",function(){return'<!DOCTYPE html>'});Macros.addMacro('!Doctype',function(a){return'<!DOCTYPE '+a+'>'});Macros.addMacro('utf-8',function(){return'<meta charset="utf-8" />'});Macros.addMacro('charset',function(a){return'<meta charset="'+a+'" />'});Macros.addMacro('keywords',function(a){return'<meta name="Keywords" content="'+a+'" />'});Macros.addMacro('description',function(a){return'<meta name="Description" content="'+a+'" />'});Macros.addMacro('author',function(a){return'<meta name="Author" content="'+a+'" />'});Macros.addMacro('viewport',function(a){return'<meta name="viewport" content="'+a+'" />'});Macros.addMacro('fb',function(a){var b=a.split(" "),selected=b[0],content=(a.replace(selected,'')).trim();return'<meta property="og:'+selected+'" content="'+content+'" />'});Macros.addMacro('tw',function(a){var b=a.split(" "),selected=b[0],content=(a.replace(selected,'')).trim();return'<meta name="twitter:'+selected+'" content="'+content+'" />'});Macros.addMacro('css',function(a){return'<link rel="stylesheet" type="text/css" href="'+a+'" />'});Macros.addMacro('favicon',function(a){return'<link rel="shortcut icon" href="'+a+'" />'});Macros.addMacro('js',function(a){return'<script type="text/javascript" src="'+a+'"></script>'});Macros.addMacro('js-async',function(a){return'<script type="text/javascript" src="'+a+'" async></script>'});Macros.addMacro('//',function(a){return'<!--'+a+'-->'});Macros.addMacro('/*',function(a){return'<!--'});Macros.addMacro('*/',function(a){return'-->'});window.Macdom={setup:{},compile:function(a){if(!a)return;l.construct(this.setup);Elements.construct(this.setup);Macros.construct(this.setup);Replicator.construct(this.setup);if(this.setup.reset&&this.setup.reset===true)this.setup={};return l.compile(a)}}}());